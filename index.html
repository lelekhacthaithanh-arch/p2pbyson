<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Pro Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --my-msg: #0084ff;
            --other-msg: #e4e6eb;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-color); display: flex; justify-content: center; height: 100vh; margin: 0; }
        .chat-container { width: 100%; max-width: 600px; display: flex; flex-direction: column; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* Header */
        .header { padding: 15px; background: white; border-bottom: 1px solid #ddd; text-align: center; }
        .my-id { font-size: 0.9em; color: #65676b; }
        #my-peer-id { font-weight: bold; color: #28a745; cursor: pointer; }

        /* Khung chat */
        #chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #fff; }
        
        /* Bong b√≥ng chat */
        .msg-row { display: flex; width: 100%; }
        .msg-row.me { justify-content: flex-end; }
        .msg-row.other { justify-content: flex-start; }
        
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; word-wrap: break-word; }
        .me .bubble { background: var(--my-msg); color: white; border-bottom-right-radius: 4px; }
        .other .bubble { background: var(--other-msg); color: black; border-bottom-left-radius: 4px; }

        .bubble img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }
        .file-box { display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .download-btn { font-size: 12px; text-decoration: underline; color: #004a8f; display: block; margin-top: 5px; }

        /* Input */
        .input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        button { padding: 8px 15px; border-radius: 20px; border: none; background: #0084ff; color: white; font-weight: bold; cursor: pointer; }
        button:hover { background: #0073e6; }
        #file-input { display: none; }
        .label-file { padding: 8px 15px; background: #e4e6eb; border-radius: 20px; cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <h3>P2P Chat X·ªãn</h3>
        <div class="my-id">ID c·ªßa b·∫°n: <span id="my-peer-id" onclick="copyId()">ƒêang l·∫•y...</span></div>
        <div class="row" style="margin-top:10px;">
            <input type="text" id="remote-id" placeholder="Nh·∫≠p ID b·∫°n b√®...">
            <button onclick="connectToPeer()">K·∫øt n·ªëi</button>
        </div>
    </div>

    <div id="chat-box"></div>

    <div class="input-area">
        <div class="row">
            <input type="text" id="message-input" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()">G·ª≠i</button>
        </div>
        <div class="row" style="justify-content: center;">
            <label class="label-file" for="file-input">üìé ƒê√≠nh k√®m t·ªáp/·∫£nh</label>
            <input type="file" id="file-input" onchange="sendFile()">
        </div>
    </div>
</div>

<script>
    let peer = new Peer();
    let conn;

    peer.on('open', id => document.getElementById('my-peer-id').innerText = id);

    // L·∫Øng nghe k·∫øt n·ªëi ƒë·∫øn
    peer.on('connection', c => {
        conn = c;
        setupChat();
    });

    function connectToPeer() {
        const rId = document.getElementById('remote-id').value;
        if (rId) {
            conn = peer.connect(rId);
            setupChat();
        }
    }

    function setupChat() {
        conn.on('open', () => {
            addStatus("ƒê√£ k·∫øt n·ªëi tr·ª±c ti·∫øp!");
            conn.on('data', data => {
                if (data.file) receiveFile(data);
                else addBubble('other', data);
            });
        });
    }

    // X·ª≠ l√Ω ph√≠m Enter
    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    function sendMessage() {
        const input = document.getElementById('message-input');
        const msg = input.value.trim();
        if (msg && conn && conn.open) {
            conn.send(msg);
            addBubble('me', msg);
            input.value = "";
        }
    }

    function sendFile() {
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if (file && conn && conn.open) {
            conn.send({
                file: file, 
                type: file.type, 
                name: file.name 
            });
            displayFile('me', file, file.name);
            fileInput.value = ""; // reset
        }
    }

    function receiveFile(data) {
        const blob = new Blob([data.file], { type: data.type });
        displayFile('other', blob, data.name);
    }

    // Hi·ªÉn th·ªã bong b√≥ng
    function addBubble(side, text) {
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg-row ${side}`;
        div.innerHTML = `<div class="bubble">${text}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function displayFile(side, blob, fileName) {
        const url = URL.createObjectURL(blob);
        const box = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = `msg-row ${side}`;
        
        let content = "";
        if (blob.type && blob.type.startsWith('image/')) {
            content = `<img src="${url}" title="B·∫•m ƒë·ªÉ t·∫£i v·ªÅ"><br><a href="${url}" download="${fileName}" class="download-btn">T·∫£i ·∫£nh v·ªÅ</a>`;
        } else {
            content = `<div class="file-box">üìÑ ${fileName}</div><a href="${url}" download="${fileName}" class="download-btn">T·∫£i t·ªáp xu·ªëng</a>`;
        }
        
        div.innerHTML = `<div class="bubble">${content}</div>`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function addStatus(text) {
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div style="text-align:center; font-size:12px; color:#888; margin:10px 0;">${text}</div>`;
    }

    function copyId() {
        const id = document.getElementById('my-peer-id').innerText;
        navigator.clipboard.writeText(id);
        alert("ƒê√£ copy ID!");
    }
</script>
</body>
</html>